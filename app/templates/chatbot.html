{% extends 'base.html' %}
{% block content %}
<style>
        /* Custom Scrollbar Styling */
        .custom-scroll::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background: #000000;
            border-radius: 10px;
        }
        .custom-scroll::-webkit-scrollbar-track {
            background: #1f2937;
        }

        /* Body Styling */
        body {
            background: linear-gradient(to bottom right, #4b5563, #000);
            color: white;
            font-family: 'Poppins', sans-serif;
        }

        /* Chat Interface Styling */
        .chat-wrapper {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chat-container {
            width: 70%;
            max-width: 600px;
            height: 75vh;
            background: linear-gradient(to bottom right, #1c453c, #1f2937, #000);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            border-radius: 30px;
            display: flex;
            flex-direction: column;
        }

        header {
            background: #2f855a;
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            font-size: 24px;
            font-weight: bold;
            letter-spacing: 1px;
        }

        .lang-button {
            background: #4a5568;
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            margin: 0 8px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .lang-button:hover {
            background: #2d3748;
        }

        .chat-messages {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .message {
            display: flex;
            align-items: flex-start;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
        }

        .bot-message {
            animation: fadeInLeft 0.5s ease-out;
        }

        .user-message {
            animation: fadeInRight 0.5s ease-out;
        }

        .message-content {
            margin-left: 16px;
            padding: 12px 16px;
            background: #2d3748;
            border-radius: 20px;
            max-width: 75%;
        }

        .input-container {
            background: #4a5568;
            padding: 16px;
            display: flex;
            align-items: center;
            border-top: 1px solid #2d3748;
        }

        .input-container input {
            width: 100%;
            padding: 12px;
            border-radius: 8px 0 0 8px;
            border: none;
            background: #2d3748;
            color: white;
            placeholder: gray;
        }

        .input-container button {
            background: #38a169;
            padding: 12px 24px;
            border-radius: 0 8px 8px 0;
            color: white;
            font-weight: bold;
            border: none;
            cursor: pointer;
            transition: background 0.3s;
        }

        .input-container button:hover {
            background: #2f855a;
        }

        @keyframes fadeInLeft {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes fadeInRight {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
    </style>
</head>
<body>
    <!-- Chat Interface Wrapper -->
    <div class="chat-wrapper">
        <div class="chat-container">

            <!-- Header Section -->
            <header>
                <h1>AnnadattaMitra AI</h1>
                <button id="call-btn" class="lang-button">üìû Call Assistant</button>
            </header>

            <div class="bg-gray-800 p-2 flex justify-end border-t border-gray-700">
                <button id="lang-en" class="lang-button">English</button>
                <button id="lang-hi" class="lang-button">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</button>
            </div>

            <!-- Chat Messages Section -->
            <div id="chat-window" class="chat-messages custom-scroll">
                <div class="message bot-message">
                    <img src="https://cdn-icons-png.flaticon.com/512/194/194938.png" class="avatar" alt="Bot" />
                    <div class="message-content">
                        <p>Hello! I'm your farming assistant. üå± How can I assist you today?</p>
                    </div>
                </div>
            </div>

            <div class="input-container">
                <input 
                    type="text" 
                    id="user-input" 
                    placeholder="Type your message..."
                    required 
                />
                <button 
                    id="send-btn">
                    Send
                </button>
            </div>
        </div>
    </div>
</body>
</html>
<script>
    const chatWindow = document.getElementById('chat-window');
    const sendButton = document.getElementById('send-btn');
    const userInput = document.getElementById('user-input');
    const callButton = document.getElementById('call-btn');

    // Scroll to bottom helper function
    function scrollToBottom() {
        chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    // Add a new chat message (either bot or user)
    function addMessage(content, sender = 'user') {
        const message = document.createElement('div');
        message.classList.add('message', `${sender}-message`, 'flex', 'items-start', 'mb-4');

        if (sender === 'bot') {
            message.innerHTML = `
                <img src="https://cdn-icons-png.flaticon.com/512/194/194938.png" class="avatar" alt="Bot" />
                <div class="ml-4 px-4 py-3 bg-gray-800 rounded-2xl max-w-[75%]">
                    <p>${content}</p>
                </div>
            `;
        } else {
            message.innerHTML = `
                <div class="ml-auto px-4 py-3 bg-green-700 rounded-2xl max-w-[75%]">
                    <p>${content}</p>
                </div>
            `;
        }

        chatWindow.appendChild(message);
        scrollToBottom();
    }
    sendButton.addEventListener('click', () => {
        const userMessage = userInput.value.trim();
        if (userMessage) {
            addMessage(userMessage, 'user');  // Add user's message
            userInput.value = '';  // Clear input

            // AJAX request to send message to Django backend
            fetch('/chat_api/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),  // CSRF token
                },
                body: JSON.stringify({ message: userMessage }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.response) {
                    addMessage(data.response, 'bot');  // Add bot's response
                } else if (data.error) {
                    addMessage(`Error: ${data.error}`, 'bot');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                addMessage('Error: Unable to connect to the server.', 'bot');
            });
        }
    });

    // Helper function to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                // Check if this cookie string begins with the name we want
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Handle call button click
    callButton.addEventListener('click', () => {
        alert('Calling your farming assistant...');
    });
</script>

{% endblock content %}
